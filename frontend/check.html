<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LifeLink - Check & Verify Relief</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Lato&family=Montserrat:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="check.css">
  <link rel="stylesheet" href="navbar.css">
  <script src="qr.js" defer></script>
  <link rel="icon" type="image/png" href="assets/logo.png">
  <style>
    .qr-code-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .qr-code-container canvas {
      border: 8px solid white;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .qr-code-label {
      font-size: 0.9rem;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body class="fade-out">
  <!-- Navigation -->
  <header class="navbar" role="banner">
    <nav aria-label="Main navigation">
      <a href="index.html" class="logo">
        <img src="assets/lifelink-logo.png" alt="LifeLink" class="nav-logo">
      </a>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About Us</a></li>
        <li><a href="add.html">Add Relief</a></li>
        <li><a href="check.html" class="active" aria-current="page">Check Relief</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="verify-section fade-up" aria-labelledby="verify-heading">
      <h2 id="verify-heading">Relief Verification &amp; Audit</h2>

      <!-- Login Panel -->
      <div id="loginPanel" class="card" aria-live="polite">
        <h3>Secure Login <span aria-label="for NGO, Government, or Admin" title="NGO / Gov‚Äôt / Admin">üîí</span></h3>
        <form id="loginForm" autocomplete="on">
          <label for="loginUsername">Username</label>
          <input type="text" id="loginUsername" name="username" placeholder="Username" autocomplete="username" required>
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" name="password" placeholder="Password" autocomplete="current-password" required>
          <button class="btn" type="submit">Login</button>
        </form>
        <p id="loginMessage" role="alert"></p>
      </div>

      <!-- Public Verification -->
      <div id="verifyPanel" class="card" aria-live="polite">
        <h3>Verify Relief Record <span title="Public Verification">üîç</span></h3>
        <form id="verifyForm" autocomplete="off">
          <label for="txHashInput">Transaction Hash</label>
          <input type="text" id="txHashInput" name="txHash" placeholder="Enter Transaction Hash" required>
          <button class="btn" type="submit">Verify</button>
        </form>
        <div id="verifyResult" class="result-box" tabindex="0"></div>
      </div>

      <!-- Audit Trail -->
      <div id="auditPanel" class="card" style="display:none;" aria-live="polite">
        <h3>Audit Trail <span title="Authorized Roles Only">üõ°Ô∏è</span></h3>
        <button class="btn" id="loadAuditBtn" type="button">Load Audit Trail</button>
        <pre id="auditResult" class="result-box" tabindex="0"></pre>
      </div>
    </section>
  </main>

  <footer class="fade-up">
    <p>¬© 2025 LifeLink. All rights reserved.</p>
  </footer>

  <script>
    const API_BASE = "http://localhost:5000";
    let authToken = null;
    let currentRole = null;

    function showPanelsAfterLogin() {
      document.getElementById("loginPanel").style.display = "none";
      if (["admin", "auditor", "govt"].includes(currentRole)) {
        document.getElementById("auditPanel").style.display = "block";
      }
    }

    async function login(username, password) {
      const msg = document.getElementById("loginMessage");
      msg.textContent = "";
      try {
        const resp = await fetch(API_BASE + "/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const j = await resp.json();
        if (resp.ok) {
          authToken = j.token;
          currentRole = j.role || null;
          msg.textContent = "‚úÖ Logged in as: " + currentRole;
          showPanelsAfterLogin();
        } else {
          msg.textContent = "‚ùå Login failed: " + (j.message || "Unknown error");
        }
      } catch (err) {
        msg.textContent = "‚ö†Ô∏è Server error: " + err.message;
      }
    }

    async function verifyRecord(txHash) {
      const result = document.getElementById("verifyResult");
      result.textContent = "";
      try {
        const resp = await fetch(`${API_BASE}/verifyRecord/${encodeURIComponent(txHash)}`);
        const j = await resp.json();
        if (resp.ok) {
          let out = `<h4>‚úÖ Record Found (${j.type ? j.type.toUpperCase() : "RECORD"})</h4>`;
          for (const [key, value] of Object.entries(j.data || {})) {
            out += `<p><strong>${key}:</strong> ${value}</p>`;
          }
          out += `<p><strong>Transaction Hash:</strong> ${txHash}</p>`;
          
          // Create QR code
          const verificationUrl = `${API_BASE}/verifyRecord/${txHash}`;
          const qrContainer = document.createElement('div');
          qrContainer.className = 'qr-code-container';
          
          // Generate QR code
          const qrCode = QR.generate(verificationUrl, 200);
          qrContainer.appendChild(qrCode);
          
          // Add label
          const label = document.createElement('div');
          label.className = 'qr-code-label';
          label.innerHTML = `
            <p>Scan to verify on blockchain</p>
            <a href="${verificationUrl}" target="_blank" rel="noopener">üîó Open verification link</a>
          `;
          qrContainer.appendChild(label);
          
          result.innerHTML = out;
          result.appendChild(qrContainer);
        } else {
          result.textContent = "‚ùå Error: " + (j.message || "Not found");
        }
      } catch (err) {
        result.textContent = "‚ö†Ô∏è Server error: " + err.message;
      }
    }

    async function loadAuditTrail() {
      const result = document.getElementById("auditResult");
      result.textContent = "";
      if (!authToken) {
        alert("Login required to view audit trail");
        return;
      }
      try {
        const resp = await fetch(API_BASE + "/auditTrail", {
          method: "GET",
          headers: { "Authorization": "Bearer " + authToken }
        });
        const j = await resp.json();
        if (resp.ok) {
          result.textContent = JSON.stringify(j, null, 2);
        } else {
          result.textContent = "‚ùå Error: " + (j.message || "Not found");
        }
      } catch (err) {
        result.textContent = "‚ö†Ô∏è Server error: " + err.message;
      }
    }

    // Event listeners for forms and buttons
    window.addEventListener("DOMContentLoaded", () => {
      document.body.classList.remove("fade-out");
      document.querySelectorAll(".fade-up").forEach(el => {
        setTimeout(() => el.classList.add("show"), 200);
      });

      document.getElementById("loginForm").addEventListener("submit", e => {
        e.preventDefault();
        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value;
        if (!username || !password) {
          document.getElementById("loginMessage").textContent = "Provide both username & password";
          return;
        }
        login(username, password);
      });

      document.getElementById("verifyForm").addEventListener("submit", e => {
        e.preventDefault();
        const txHash = document.getElementById("txHashInput").value.trim();
        if (!txHash) {
          document.getElementById("verifyResult").textContent = "Please enter a transaction hash";
          return;
        }
        verifyRecord(txHash);
      });

      document.getElementById("loadAuditBtn").addEventListener("click", loadAuditTrail);
    });
  </script>
</body>
</html>
