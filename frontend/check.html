<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LifeLink - Check & Verify Relief</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Lato&family=Montserrat:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="check.css">
  <link rel="stylesheet" href="navbar.css">
  <script src="qr.js" defer></script>
  <!-- Leaflet Map (for live package tracking) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <link rel="icon" type="image/png" href="assets/lifelink-logo.png">
  <style>
    .qr-code-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .qr-code-container canvas {
      border: 8px solid white;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .qr-code-label {
      font-size: 0.9rem;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body class="fade-out">
  <!-- Navigation -->
  <header class="navbar" role="banner">
    <nav aria-label="Main navigation">
      <a href="index.html" class="logo">
        <img src="assets/logo.jpg" alt="LifeLink" class="nav-logo">
      </a>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About Us</a></li>
        <li><a href="add.html">Add Relief</a></li>
        <li><a href="check.html" class="active" aria-current="page">Check Relief</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="verify-section fade-up" aria-labelledby="verify-heading">
      <h2 id="verify-heading">Relief Verification &amp; Audit</h2>

      <!-- Login Panel -->
      <div id="loginPanel" class="card" aria-live="polite">
        <h3>Secure Login <span aria-label="for NGO, Government, or Admin" title="NGO / Gov‚Äôt / Admin">üîí</span></h3>
        <form id="loginForm" autocomplete="on">
          <label for="loginUsername">Username</label>
          <input type="text" id="loginUsername" name="username" placeholder="Username" autocomplete="username" required>
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" name="password" placeholder="Password" autocomplete="current-password" required>
          <button class="btn" type="submit">Login</button>
        </form>
        <p id="loginMessage" role="alert"></p>
      </div>

      <!-- Public Verification -->
      <div id="verifyPanel" class="card" aria-live="polite">
        <h3>Verify Relief Record <span title="Public Verification">üîç</span></h3>
        <form id="verifyForm" autocomplete="off">
          <label for="txHashInput">Transaction Hash</label>
          <input type="text" id="txHashInput" name="txHash" placeholder="Enter Transaction Hash" required>
          <button class="btn" type="submit">Verify</button>
        </form>
        <div id="verifyResult" class="result-box" tabindex="0"></div>
      </div>

      <!-- Audit Trail -->
      <div id="auditPanel" class="card" style="display:none;" aria-live="polite">
        <h3>Audit Trail <span title="Authorized Roles Only">üõ°Ô∏è</span></h3>
        <button class="btn" id="loadAuditBtn" type="button">Load Audit Trail</button>
        <div id="auditResult" class="result-box" tabindex="0"></div>
      </div>
    </section>
  </main>

  <footer class="fade-up">
    <p>¬© 2025 LifeLink. All rights reserved.</p>
  </footer>

  <script>
    const API_BASE = "http://localhost:5000";
    let authToken = null;
    let currentRole = null;

    function showPanelsAfterLogin() {
      document.getElementById("loginPanel").style.display = "none";
      if (["admin", "auditor", "govt"].includes(currentRole)) {
        document.getElementById("auditPanel").style.display = "block";
      }
    }

    async function login(username, password) {
      const msg = document.getElementById("loginMessage");
      msg.textContent = "";
      try {
        const resp = await fetch(API_BASE + "/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const j = await resp.json();
        if (resp.ok) {
          authToken = j.token;
          currentRole = j.role || null;
          msg.textContent = "‚úÖ Logged in as: " + currentRole;
          showPanelsAfterLogin();
        } else {
          msg.textContent = "‚ùå Login failed: " + (j.message || "Unknown error");
        }
      } catch (err) {
        msg.textContent = "‚ö†Ô∏è Server error: " + err.message;
      }
    }

    // Geocode a location name to coordinates using Nominatim
    async function geocodeLocation(name) {
      try {
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}`);
        const arr = await resp.json();
        if (Array.isArray(arr) && arr.length > 0) {
          return { lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon) };
        }
      } catch (_) {}
      return null;
    }

    function initLeafletMap(targetId, lat, lng, label, status) {
      if (!window.L || !document.getElementById(targetId)) return;
      const map = L.map(targetId).setView([lat, lng], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      L.marker([lat, lng]).addTo(map)
        .bindPopup(`<strong>${label || 'Current Location'}</strong>${status ? `<br>Status: ${status}` : ''}`)
        .openPopup();
    }

    function initEmptyMap(targetId) {
      if (!window.L || !document.getElementById(targetId)) return;
      const map = L.map(targetId).setView([20.5937, 78.9629], 4); // Center on India
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }

    async function verifyRecord(txHash) {
      const result = document.getElementById("verifyResult");
      result.textContent = "";
      try {
        const resp = await fetch(`${API_BASE}/verifyRecord/${encodeURIComponent(txHash)}`);
        const j = await resp.json();
        if (!resp.ok) {
          result.textContent = "‚ùå Error: " + (j.message || "Not found");
          return;
        }

        const type = (j.type || '').toLowerCase();
        const data = j.data || {};
        const verifyUrl = `${API_BASE}/verifyRecord/${txHash}`;

        // Build summary content per type
        let summaryHTML = '';
        if (type === 'donation') {
          const id = data.id || txHash;
          const donor = data.details?.donorName || 'Anonymous';
          const amount = new Intl.NumberFormat('en-IN', { style: 'currency', currency: data.details?.currency || 'INR' }).format(data.details?.amount || 0);
          const purpose = data.details?.purpose || '-';
          const status = (data.tracking?.status || '-').replace('_', ' ');
          const when = data.tracking?.createdAt ? new Date(data.tracking.createdAt).toLocaleString() : '-';
          const reached = data.tracking?.location?.locationName || data.tracking?.lastKnownLocation || '-';
          const dLoc = data.tracking?.location;
          const hasCoords = dLoc && typeof dLoc.lat === 'number' && typeof dLoc.lng === 'number';
          const mapId = `verify-map-${Date.now()}`;

          summaryHTML = `
            <div class="verify-summary">
              <div class="vs-left">
                <div class="vs-header">
                  <span class="vs-badge success">Donation</span>
                  <span class="vs-id" title="${id}">${id}</span>
                </div>
                <ul class="vs-list">
                  <li><span>Donor</span><strong>${donor}</strong></li>
                  <li><span>Amount</span><strong>${amount}</strong></li>
                  <li><span>Purpose</span><strong>${purpose}</strong></li>
                  <li><span>Status</span><strong class="status">${status}</strong></li>
                  <li><span>Date</span><strong>${when}</strong></li>
                  <li><span>Reached</span><strong>${reached}</strong></li>
                </ul>
                <div class="verify-map" id="${mapId}" aria-label="Package Location Map"></div>
              </div>
              <div class="vs-right">
                <div class="qr-code-container">
                  <img src="${makeQrSrc(verifyUrl)}" alt="QR to verify ${id}" width="180" height="180" />
                  <div class="qr-code-label">
                    <p>Scan to verify on blockchain</p>
                    <a href="${verifyUrl}" target="_blank" rel="noopener"> Open verification link</a>
                  </div>
                </div>
              </div>
            </div>`;

          // After injecting, initialize map (coords or geocode by name), otherwise empty map
          setTimeout(async () => {
            try {
              if (document.getElementById(mapId)) {
                if (hasCoords) {
                  initLeafletMap(mapId, dLoc.lat, dLoc.lng, reached, status);
                } else if (reached && reached !== '-') {
                  const g = await geocodeLocation(reached);
                  if (g) initLeafletMap(mapId, g.lat, g.lng, reached, status); else initEmptyMap(mapId);
                }
                else {
                  initEmptyMap(mapId);
                }
              }
            } catch (_) {}
          }, 0);
        } else if (type === 'supply' || type === 'supplies') {
          const id = data.id || txHash;
          const item = data.details?.item || '-';
          const qty = data.details?.quantity != null ? `${data.details.quantity} ${data.details?.unit || ''}`.trim() : '-';
          const from = data.logistics?.from?.name || '-';
          const to = data.logistics?.to?.name || '-';
          const where = data.logistics?.location?.locationName || '-';
          const status = (data.tracking?.status || '-').replace('_', ' ');
          const when = data.tracking?.createdAt ? new Date(data.tracking.createdAt).toLocaleString() : '-';
          const loc = data.logistics?.location;
          const hasCoords = loc && typeof loc.lat === 'number' && typeof loc.lng === 'number';
          const mapId = `verify-map-${Date.now()}`;

          summaryHTML = `
            <div class="verify-summary">
              <div class="vs-left">
                <div class="vs-header">
                  <span class="vs-badge info">Supply</span>
                  <span class="vs-id" title="${id}">${id}</span>
                </div>
                <ul class="vs-list">
                  <li><span>Item</span><strong>${item}</strong></li>
                  <li><span>Quantity</span><strong>${qty}</strong></li>
                  <li><span>From ‚Üí To</span><strong>${from} ‚Üí ${to}</strong></li>
                  <li><span>Current Location</span><strong>${where}</strong></li>
                  <li><span>Status</span><strong class="status">${status}</strong></li>
                  <li><span>Updated</span><strong>${when}</strong></li>
                </ul>
                <div class="verify-map" id="${mapId}" aria-label="Package Location Map"></div>
              </div>
              <div class="vs-right">
                <div class="qr-code-container">
                  <img src="${makeQrSrc(verifyUrl)}" alt="QR to verify ${id}" width="180" height="180" />
                  <div class="qr-code-label">
                    <p>Scan to verify on blockchain</p>
                    <a href="${verifyUrl}" target="_blank" rel="noopener"> Open verification link</a>
                  </div>
                </div>
              </div>
            </div>`;

          // Initialize map for supplies (coords or geocode by name), otherwise empty map
          setTimeout(async () => {
            try {
              if (document.getElementById(mapId)) {
                if (hasCoords) {
                  initLeafletMap(mapId, loc.lat, loc.lng, where, status);
                } else if (where && where !== '-') {
                  const g = await geocodeLocation(where);
                  if (g) initLeafletMap(mapId, g.lat, g.lng, where, status); else initEmptyMap(mapId);
                }
                else {
                  initEmptyMap(mapId);
                }
              }
            } catch (_) {}
          }, 0);
        } else {
          // Fallback minimal view
          summaryHTML = `<div class="verify-summary"><div class="vs-left"><div class="vs-header"><span class="vs-badge">Record</span><span class="vs-id">${txHash}</span></div></div></div>`;
        }

        result.innerHTML = `<h4>‚úÖ Record Found (${(j.type || 'Record').toUpperCase()})</h4>` + summaryHTML;
      } catch (err) {
        result.textContent = "‚ö†Ô∏è Server error: " + err.message;
      }
    }

    function makeVerifyUrl(id) {
      return `${API_BASE}/verifyRecord/${encodeURIComponent(id)}`;
    }

    function makeQrSrc(url) {
      const encoded = encodeURIComponent(url);
      return `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encoded}`;
    }

    async function loadAuditTrail() {
      const result = document.getElementById("auditResult");
      result.innerHTML = "";
      if (!authToken) {
        alert("Login required to view audit trail");
        return;
      }
      try {
        const resp = await fetch(API_BASE + "/auditTrail", {
          method: "GET",
          headers: { "Authorization": "Bearer " + authToken }
        });
        const data = await resp.json();
        if (!resp.ok) {
          result.textContent = "‚ùå Error: " + (data.message || "Not found");
          return;
        }

        // Build donation ID-only list with QR
        const wrapper = document.createElement('div');
        wrapper.className = 'audit-id-list';

        (data.donations || []).forEach(d => {
          const id = d.id || d.tracking?.verificationId || d.blockchain?.txHash || '';
          const item = document.createElement('div');
          item.className = 'audit-id-item';

          const left = document.createElement('div');
          left.className = 'id-left';
          left.innerHTML = `
            <div class="id-label">Transaction ID</div>
            <div class="id-value" title="${id}">${id}</div>
            <div class="id-actions">
              <button class="copy-btn" data-copy-id="${id}">Copy</button>
              <a class="verify-link" href="${makeVerifyUrl(id)}" target="_blank" rel="noopener">Open</a>
            </div>`;

          const right = document.createElement('a');
          right.className = 'qr-right';
          right.href = makeVerifyUrl(id);
          right.target = '_blank';
          right.rel = 'noopener';
          // Use same QR style as home (external image)
          const qrImg = document.createElement('img');
          qrImg.src = makeQrSrc(makeVerifyUrl(id));
          qrImg.alt = `QR to verify ${id}`;
          qrImg.width = 140;
          qrImg.height = 140;
          right.appendChild(qrImg);
          const span = document.createElement('span');
          span.textContent = 'Scan to verify';
          right.appendChild(span);

          item.appendChild(left);
          item.appendChild(right);
          wrapper.appendChild(item);
        });

        result.appendChild(wrapper);

        // Copy behavior
        result.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-copy-id]');
          if (!btn) return;
          const val = btn.getAttribute('data-copy-id');
          navigator.clipboard.writeText(val).then(() => {
            btn.textContent = 'Copied';
            setTimeout(() => (btn.textContent = 'Copy'), 1200);
          });
        });
      } catch (err) {
        result.textContent = "‚ö†Ô∏è Server error: " + err.message;
      }
    }

    // Event listeners for forms and buttons
    window.addEventListener("DOMContentLoaded", () => {
      document.body.classList.remove("fade-out");
      document.querySelectorAll(".fade-up").forEach(el => {
        setTimeout(() => el.classList.add("show"), 200);
      });

      document.getElementById("loginForm").addEventListener("submit", e => {
        e.preventDefault();
        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value;
        if (!username || !password) {
          document.getElementById("loginMessage").textContent = "Provide both username & password";
          return;
        }
        login(username, password);
      });

      document.getElementById("verifyForm").addEventListener("submit", e => {
        e.preventDefault();
        const txHash = document.getElementById("txHashInput").value.trim();
        if (!txHash) {
          document.getElementById("verifyResult").textContent = "Please enter a transaction hash";
          return;
        }
        verifyRecord(txHash);
      });

      document.getElementById("loadAuditBtn").addEventListener("click", loadAuditTrail);
    });
  </script>
</body>
</html>
